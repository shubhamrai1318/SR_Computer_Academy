<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | SR Study Library</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* --- ENHANCED MODERN STYLES --- */
    :root {
      --primary: #4a90e2; 
      --primary-dark: #357bd8;
      --accent: #06c7e3; 
      --bg: #f7f9fc; 
      --card-bg: #ffffff;
      --sidebar-bg: #1e3a8a; 
      --text-dark: #2c3e50;
      --text-light: #fff;
      --shadow-subtle: 0 4px 6px rgba(0, 0, 0, 0.08);
      --shadow-card: 0 10px 20px rgba(0, 0, 0, 0.05);
      --success: #2ecc71; 
      --danger: #e74c3c; 
    }

    body.dark {
      --bg: #121212; 
      --card-bg: #1e1e1e;
      --sidebar-bg: #1f2937; 
      --text-dark: #e0e0e0;
      --shadow-subtle: 0 4px 6px rgba(0, 0, 0, 0.25);
      --shadow-card: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: var(--bg);
      display: flex; 
      height: 100vh;
      overflow: hidden;
      transition: background 0.4s ease;
      scroll-behavior: smooth;
    }

    /* --- SIDEBAR --- */
    .sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      padding: 30px 20px;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 6px 0 15px rgba(0, 0, 0, 0.2);
      z-index: 100;
      flex-shrink: 0;
    }

    /* Desktop View (769px and up) */
    @media (min-width: 769px) {
        .sidebar {
            position: static; 
            transform: none; 
        }
        .toggle-btn {
            display: none !important;
        }
    }

    /* Mobile View (768px and down) */
    @media (max-width: 768px) {
        .sidebar {
            position: fixed;
            height: 100%;
            left: 0;
            top: 0;
            transform: translateX(-100%);
            width: 280px; 
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .sidebar.active {
            transform: translateX(0);
        }
        
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }

        .sidebar.active ~ .sidebar-overlay {
            display: block;
        }
    }


    .sidebar h2 {
      font-size: 24px;
      margin-bottom: 40px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-align: center;
    }

    .sidebar a {
      text-decoration: none;
      color: var(--text-light);
      padding: 14px 18px;
      border-radius: 12px;
      margin: 6px 0;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .sidebar a:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateX(3px);
    }
    
    .sidebar a.active {
        background: rgba(255, 255, 255, 0.25);
    }

    .sidebar a.active::before { 
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--accent);
    }

    .theme-toggle {
      margin-top: auto;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      transition: 0.3s;
    }

    .toggle-btn {
      display: none; 
      background: var(--primary);
      color: #fff;
      border: none;
      font-size: 20px;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1001;
    }
    
    @media (max-width: 768px) {
        .toggle-btn {
            display: block;
        }
    }

    /* --- MAIN AREA --- */
    .main {
      flex: 1; 
      padding: 30px 40px;
      overflow-y: auto;
      transition: padding 0.3s;
      width: 100%; 
      box-sizing: border-box;
    }

    header {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px 30px;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 30px;
      box-shadow: var(--shadow-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .add-record-btn {
        background: var(--success);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 18px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s, transform 0.3s;
    }

    .download-btn {
      background: var(--accent);
      border: none;
      padding: 10px 18px;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.3s, transform 0.3s;
    }

    header button#logoutBtnTop {
      background: var(--danger);
      border-radius: 8px;
      padding: 10px 18px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s, transform 0.3s;
      color: white;
    }

    /* --- WIDGETS SECTION --- */
    .dashboard-widgets {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .widget-card {
        background: var(--card-bg);
        border-radius: 15px;
        padding: 20px;
        box-shadow: var(--shadow-subtle);
        transition: transform 0.3s ease;
        border-left: 5px solid var(--primary);
    }
    
    .widget-card h3 {
        margin: 0 0 5px 0;
        font-size: 14px;
        color: var(--primary);
        font-weight: 500;
        text-transform: uppercase;
    }

    .widget-card p {
        margin: 0;
        font-size: 32px;
        font-weight: 700;
        color: var(--text-dark);
    }

    .container {
      background: var(--card-bg);
      border-radius: 15px;
      box-shadow: var(--shadow-card);
      padding: 30px;
    }
    
    /* --- SEARCH BAR AND FILTER LAYOUT (FIXED) --- */
    #filters {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 25px;
        padding: 15px; 
        background: var(--bg); 
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); 
    }
    
    body.dark #filters {
        background: #1e1e1e;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
    }

    /* Apply new styles to all filter/search inputs */
    #searchBar, #statusFilter {
        padding: 12px 18px; 
        border: 2px solid #e0e0e0; 
        border-radius: 8px; 
        font-size: 15px;
        transition: border-color 0.3s, box-shadow 0.3s;
        background-color: var(--card-bg);
        color: var(--text-dark);
    }
    
    body.dark #searchBar, body.dark #statusFilter {
        border-color: #444;
    }
    
    #searchBar:focus, #statusFilter:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); 
        outline: none;
    }

    #searchBar {
        flex: 1;
        min-width: 250px; 
    }

    /* Styling for the dropdown selector */
    #statusFilter {
        width: 180px; 
        -webkit-appearance: none; 
        -moz-appearance: none;    
        appearance: none;         
        
        /* Custom dropdown arrow (SVG data URI) */
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%234A90E2" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>');
        background-repeat: no-repeat;
        background-position: right 15px center;
        padding-right: 35px; 
    }
    /* --- END FILTER FIX --- */

    /* --- TABLE STYLES --- */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      border-radius: 12px;
      overflow: hidden;
      min-width: 800px;
      table-layout: auto;
    }

    th {
      background: var(--primary);
      color: #fff;
      text-align: left;
      padding: 14px 12px;
      cursor: pointer;
      position: sticky;
      top: 0;
      z-index: 1;
      font-weight: 600;
    }
    
    td {
      padding: 15px 12px;
      border-bottom: 1px solid #f0f0f0;
      color: var(--text-dark);
    }
    
    tr:hover {
      background: rgba(74, 144, 226, 0.06);
      transition: background 0.3s;
    }

    .action-btn {
        background: var(--accent);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.3s;
        font-size: 12px;
    }
    
    .username-link { 
        color: var(--primary);
        font-weight: 600;
        cursor: pointer;
        text-decoration: underline;
        transition: color 0.2s;
    }
    .username-link:hover {
        color: var(--primary-dark);
    }


    /* --- MODAL STYLES --- */
    .modal {
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        display: none;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
        background-color: var(--card-bg);
        margin: auto;
        padding: 30px;
        border-radius: 15px;
        box-shadow: var(--shadow-card);
        width: 90%;
        max-width: 500px;
        animation: slideIn 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        color: var(--text-dark);
    }
    
    /* Details Display Styling */
    .details-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px dashed #eee;
    }
    
    .details-row:last-child {
        border-bottom: none;
    }
    
    .details-label {
        font-weight: 500;
        color: #777;
    }
    
    .details-value {
        font-weight: 600;
        color: var(--text-dark);
        text-align: right;
        max-width: 60%;
    }

    /* Form and general modal styling */
    .close-btn { color: var(--danger); float: right; font-size: 28px; font-weight: bold; transition: 0.3s; }
    .close-btn:hover { color: #000; text-decoration: none; cursor: pointer; }
    .form-group { position: relative; margin-bottom: 25px; }
    .form-group input, .form-group select { width: 100%; padding: 15px 10px 5px 10px; border: none; border-bottom: 2px solid #ccc; background: transparent; font-size: 16px; color: var(--text-dark); transition: border-bottom-color 0.3s; }
    .modal-submit-btn { width: 100%; background: var(--primary); color: white; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; transition: 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    /* Pagination Style */
    .pagination {
        display: flex;
        justify-content: flex-end; 
        align-items: center;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
        gap: 8px; 
    }
    
    body.dark .pagination {
        border-top: 1px solid #4b5563;
    }

    .pagination button {
        background: none;
        border: 1px solid #ccc;
        color: var(--text-dark);
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s ease;
        min-width: 40px;
        text-align: center;
    }

    .pagination button:hover {
        background: var(--primary);
        color: var(--text-light);
        border-color: var(--primary);
    }

    .pagination button.active {
        background: var(--primary);
        color: var(--text-light);
        border-color: var(--primary);
        font-weight: 600;
        box-shadow: 0 2px 5px rgba(74, 144, 226, 0.4);
    }

    /* --- MOBILE SPECIFIC FIXES --- */
    @media(max-width: 768px) {
      .main { padding: 20px; width: 100%; box-sizing: border-box; }
      .toggle-btn { display: block; }
      header { flex-direction: column; align-items: flex-start; padding: 15px 20px; position: static; }
      .header-actions { width: 100%; justify-content: space-between; }
      .header-actions button { flex: 1; }
      .dashboard-widgets { grid-template-columns: 1fr; }
      table { font-size: 12px; min-width: 600px; }
      #filters { flex-direction: column; padding: 10px; }
      #searchBar, #statusFilter { min-width: 100%; width: 100%; }
    }
  </style>
</head>

<body>
  <button class="toggle-btn" onclick="toggleSidebar()">☰</button>

  <div class="sidebar" id="sidebar">
    <h2>SRCA Admin Dashboard</h2>
    <a href="#" class="active" onclick="handleSidebarLinkClick(event)">📊 Dashboard</a>
    <a href="#" onclick="handleSidebarLinkClick(event)">📋 Records View</a>
    <a href="#" onclick="handleSidebarLinkClick(event)">🧑‍💻 User Management</a>
    <a href="#" onclick="handleSidebarLinkClick(event)">⚙️ Settings</a>
    <a href="#" id="logoutBtn">🚪 Logout</a>
    <button class="theme-toggle" onclick="toggleTheme()">🌓 Toggle Theme</button>
  </div>
  
  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div class="main">
    <header>
      <span id="headerTitle">SRCA Admin Dashboard — Student Records</span>
      <div class="header-actions">
        <button class="add-record-btn" onclick="openAddRecordModal()">➕ Add New Record</button>
        <button class="download-btn" onclick="downloadCSV()">⬇ CSV</button>
        <button id="logoutBtnTop">Logout</button>
      </div>
    </header>
    
    <div class="dashboard-widgets">
        <div class="widget-card" style="border-left-color: var(--success);">
            <h3>Total Students</h3>
            <p id="totalStudentsCount">...</p>
        </div>
        <div class="widget-card" style="border-left-color: var(--primary);">
            <h3>Active Users</h3>
            <p id="activeStudentsCount">...</p>
        </div>
        <div class="widget-card" style="border-left-color: var(--danger);">
            <h3>Inactive Users</h3>
            <p id="inactiveStudentsCount">...</p>
        </div>
        <div class="widget-card" style="border-left-color: var(--accent);">
            <h3>Records Shown</h3>
            <p id="recordsDisplayed">0</p>
        </div>
    </div>

    <div class="container">
      <h2>Student Data Overview</h2>
      <div id="filters">
        <input type="text" id="searchBar" placeholder="Search by name, course, or username..." />
        <select id="statusFilter">
          <option value="all">All Status</option>
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
        </select>
      </div>

      <div id="tableContainer"><p>Loading student data...</p></div>
      <div class="pagination" id="pagination"></div>
    </div>
  </div>
  
  <div id="addRecordModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeAddRecordModal()">&times;</span>
      <h3>➕ Add New Student Record</h3>
      <form id="addRecordForm">
        
        <div class="form-group">
            <input type="text" id="addName" name="Name" placeholder=" " required />
            <label for="addName">Full Name</label>
        </div>

        <div class="form-group">
            <input type="text" id="addCourse" name="Course" placeholder=" " required />
            <label for="addCourse">Course/Program</label>
        </div>
        
        <div class="form-group">
            <input type="text" id="addUsername" name="Username" placeholder=" " required />
            <label for="addUsername">Username (Unique ID)</label>
        </div>
        
        <div class="form-group">
             <select id="addStatus" name="Status" required>
                <option value="" disabled selected>Select Status</option>
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
            </select>
             <label for="addStatus">Status</label>
        </div>
        
        <button type="submit" class="modal-submit-btn">Submit New Record</button>
      </form>
    </div>
  </div>
  
  <div id="studentDetailsModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeDetailsModal()">&times;</span>
      <h3 id="detailsModalTitle">Student Details</h3>
      <div id="studentDetailsContent">
        </div>
      <button class="modal-submit-btn" style="margin-top: 20px; background: var(--danger);" onclick="closeDetailsModal()">Close</button>
    </div>
  </div>


  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbw00d-hkEhA3iUinaeKaSFvHFOfN6Ig43cXSFE_jWQ55tsKgGhtd-vv3fSOdYtBYWn_/exec";
    let allStudents = [];
    let currentPage = 1;
    const rowsPerPage = 5;
    let currentSort = { column: null, order: 'asc' };

    /* --- DATA LOADING & WIDGETS --- */
    async function loadStudents() {
      document.getElementById("tableContainer").innerHTML = "<p>⏳ Fetching data from Google Sheet...</p>";
      document.getElementById("totalStudentsCount").textContent = "Loading...";

      try {
        const res = await fetch(scriptURL);
        const data = await res.json();
        if (data.status === "all" && Array.isArray(data.students)) {
          allStudents = data.students.filter(stu => stu.username && stu.username.trim() !== "-");
          updateWidgets(allStudents);
          applyFilters(); 
        } else {
          document.getElementById("tableContainer").innerHTML = "<p>⚠️ Unable to fetch student data: Invalid response format.</p>";
        }
      } catch (e) {
        console.error("Error loading data:", e);
        document.getElementById("tableContainer").innerHTML = "<p>⚠️ Error loading data. Check console for details.</p>";
      }
    }
    
    function updateWidgets(students) {
        const total = students.length;
        const active = students.filter(stu => stu.status && stu.status.toLowerCase() === 'active').length;
        const inactive = total - active;
        
        document.getElementById("totalStudentsCount").textContent = total;
        document.getElementById("activeStudentsCount").textContent = active;
        document.getElementById("inactiveStudentsCount").textContent = inactive;
    }

    /* --- TABLE RENDERING & FILTERING --- */
    function renderTable(students) {
      if (!students.length) {
        document.getElementById("tableContainer").innerHTML = "<p>No records found matching your filters.</p>";
        document.getElementById("pagination").innerHTML = "";
        document.getElementById("recordsDisplayed").textContent = "0";
        return;
      }

      let headers = Object.keys(students[0]);
      if (headers[headers.length - 1].toLowerCase() !== 'actions') {
          headers.push('Actions');
      }

      const start = (currentPage - 1) * rowsPerPage;
      const end = start + rowsPerPage;
      const paginated = students.slice(start, end);

      let html = "<div style='overflow-x:auto;'><table><thead><tr>";
      headers.forEach(h => {
        let indicator = '';
        if (h !== 'Actions') {
            if (currentSort.column === h) {
                indicator = currentSort.order === 'asc' ? ' ▲' : ' ▼';
            }
            html += `<th onclick="sortTable('${h}')">${h.toUpperCase()}${indicator}</th>`;
        } else {
            html += `<th>${h.toUpperCase()}</th>`;
        }
      });
      html += "</tr></thead><tbody>";

      paginated.forEach(stu => {
        html += "<tr>";
        headers.forEach(h => {
            if (h === 'Actions') {
                html += `<td><button class="action-btn" onclick="viewDetails('${stu.username}')">View Details</button></td>`;
            } else if (h.toLowerCase() === 'username') {
                // Make Username clickable
                html += `<td><span class="username-link" onclick="viewDetails('${stu.username}')">${stu[h] || "-"}</span></td>`;
            } else {
                html += `<td>${stu[h] || "-"}</td>`;
            }
        });
        html += "</tr>";
      });
      html += "</tbody></table></div>";
      document.getElementById("tableContainer").innerHTML = html;
      
      document.getElementById("recordsDisplayed").textContent = paginated.length;
      renderPagination(students.length);
    }
    
    // NEW FUNCTIONALITY: Display student details in a formatted modal
    function viewDetails(username) {
        const student = allStudents.find(s => s.username === username);
        if (!student) {
            alert(`Error: Student with username ${username} not found.`);
            return;
        }

        document.getElementById('detailsModalTitle').textContent = `Details for ${student.name || username}`;
        
        let detailsHtml = '';
        // Iterate over the student object to format the data vertically
        for (const key in student) {
            // Capitalize the first letter of the key for display
            const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1').trim();
            const value = student[key] || "N/A";

            detailsHtml += `
                <div class="details-row">
                    <span class="details-label">${label}:</span>
                    <span class="details-value">${value}</span>
                </div>
            `;
        }
        
        document.getElementById('studentDetailsContent').innerHTML = detailsHtml;
        document.getElementById('studentDetailsModal').style.display = 'flex';
    }
    
    function closeDetailsModal() {
        document.getElementById('studentDetailsModal').style.display = 'none';
    }


    function renderPagination(totalRows) {
      const totalPages = Math.ceil(totalRows / rowsPerPage);
      let paginationHTML = "";
      for (let i = 1; i <= totalPages; i++) {
        paginationHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
      }
      document.getElementById("pagination").innerHTML = paginationHTML;
    }

    function changePage(page) {
      currentPage = page;
      applyFilters(false);
    }

    function applyFilters(resetPage = true) {
      if (resetPage) currentPage = 1; 

      const search = document.getElementById("searchBar").value.toLowerCase();
      const status = document.getElementById("statusFilter").value;
      let filtered = allStudents;

      filtered = filtered.filter(stu => {
        const sMatch = (stu.name && stu.name.toLowerCase().includes(search)) ||
                       (stu.course && stu.course.toLowerCase().includes(search)) ||
                       (stu.username && stu.username.toLowerCase().includes(search));
        const statusMatch = status === "all" ||
                            (stu.status && stu.status.toLowerCase() === status.toLowerCase());
        return sMatch && statusMatch;
      });
      
      if (currentSort.column) {
          sortData(filtered, currentSort.column, currentSort.order === 'asc');
      }

      renderTable(filtered);
    }

    function sortData(data, col, asc) {
         data.sort((a, b) => {
            const va = (a[col] || "").toString().toLowerCase();
            const vb = (b[col] || "").toString().toLowerCase();
            return asc ? va.localeCompare(vb) : vb.localeCompare(va);
        });
    }

    function sortTable(col) {
        if (col === 'Actions') return;
        
        let asc = true;
        if (currentSort.column === col) {
            asc = currentSort.order !== 'asc';
        }
        
        currentSort = { column: col, order: asc ? 'asc' : 'desc' };
        sortData(allStudents, col, asc);
        applyFilters();
    }

    /* --- MODAL (ADD RECORD) FUNCTIONALITY --- */
    function openAddRecordModal() {
        document.getElementById('addRecordModal').style.display = 'flex';
        document.getElementById('addRecordForm').reset(); 
    }

    function closeAddRecordModal() {
        document.getElementById('addRecordModal').style.display = 'none';
    }

    document.getElementById('addRecordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        if (!data.Name || !data.Username) {
            alert("Please fill in required fields (Name and Username).");
            return;
        }

        alert("Simulating API call to add record:\n" + JSON.stringify(data, null, 2));

        closeAddRecordModal();
        alert("Record added (Simulated). Reloading data...");
        // loadStudents(); 
    });

    /* --- MISC UTILITIES & MOBILE FIX --- */
    document.getElementById("searchBar").addEventListener("input", () => applyFilters(true));
    document.getElementById("statusFilter").addEventListener("change", () => applyFilters(true));

    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const overlay = document.querySelector(".sidebar-overlay");
      
      sidebar.classList.toggle("active");
      
      if (sidebar.classList.contains("active")) {
          overlay.style.display = 'block';
      } else {
          overlay.style.display = 'none';
      }
    }

    function toggleTheme() {
      document.body.classList.toggle("dark");
    }

    function downloadCSV() {
      if (!allStudents.length) return alert("No data to download.");
      const headers = Object.keys(allStudents[0]);
      
      const csvContent = allStudents.map(row => 
        headers.map(h => `"${(row[h] || "").toString().replace(/"/g, '""')}"`).join(",")
      ).join("\n");
      
      const csv = headers.join(",") + "\n" + csvContent;

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "student_records.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Logout Functionality
    document.getElementById("logoutBtn").onclick =
    document.getElementById("logoutBtnTop").onclick = () => {
        alert("Logged out successfully! Redirecting to index.html...");
        window.location.href = "index.html"; 
    };
    
    // Function to handle sidebar link clicks
    function handleSidebarLinkClick(e) {
        e.preventDefault();
        
        // --- 1. Navigation Logic ---
        document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
        e.currentTarget.classList.add('active');
        
        const linkText = e.currentTarget.textContent.trim().split(/\s+/).slice(1).join(' ');
        document.getElementById('headerTitle').textContent = `Admin Dashboard — ${linkText}`;
        
        const isDashboardView = (linkText === 'Dashboard' || linkText === 'Records View');
        document.querySelector('.dashboard-widgets').style.display = isDashboardView ? 'grid' : 'none';
        document.querySelector('.container').style.display = isDashboardView ? 'block' : 'none';
        
        if (!isDashboardView) {
            alert(`Navigating to ${linkText} (Content Placeholder)`);
        }
        document.querySelector('.main').scrollTop = 0;

        // --- 2. Mobile Closing Fix ---
        if (window.innerWidth <= 768 && document.getElementById("sidebar").classList.contains("active")) {
            toggleSidebar();
        }
    }

    // Attach handler to all sidebar links except logout
    document.querySelectorAll('.sidebar a:not(#logoutBtn)').forEach(link => {
        link.removeEventListener('click', handleSidebarLinkClick); 
        link.addEventListener('click', handleSidebarLinkClick);
    });

    // Initial Data Load
    loadStudents();
  </script>
</body>
</html>